name: CI

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**/README.md'

jobs:
  test:
    name: test application
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    - run: pip install virtualenv
    - run: virtualenv venv
    - run: source venv/bin/activate
    - run: pip install -r requirements.txt
    - run: python -m pytest .
    
  build-and-push-to-docker:
    name: build and push to DockerHub
    runs-on: ubuntu-latest
    
    steps:
    - uses: mr-smithers-excellent/docker-build-push@v5
      with:
        image: ykbhlvck/husqvarna_isdoc
        tags: latest
        registry: docker.io
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
  
#   deploy:
#     name: deploy on VM
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read
      
#     steps:
#     - name: Executing remote ssh docker deploy
#       uses: appleboy/ssh-action@master
#       with:
#         host: ${{ secrets.DEPLOY_IP }}
#         username: ${{ secrets.DEPLOY_USERNAME }}
#         password: ${{ secrets.DEPLOY_PASSWORD }}
#         script: |
#           cd ${{ secrets.PROJECT_PATH }}
#           docker-compose pull && docker-compose up --detach && docker system prune -f
      
  
